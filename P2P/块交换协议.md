#### 发布/订阅系统

peer订阅自己感兴趣的主题，peer向所有主题订阅者广播信息。

- 所有信息传递给订阅主题的所有对等方
- 网络不会被过多的邮件副本淹没
- 对等方可以随意加入 / 离开
- 主题可以有大量的订阅用户并处理大量的信息



#### floodsub

对于每个传入信息，转发给该主题的所有已经知道的对等方

- 维护先前消息缓存，不会转发已经看到的。
- 不会把消息转发回源



问题

- 连接大量节点的密集节点无法承受转发带宽



#### 数据

对于传输完整的数据，我们只对有限的节点传输完整的数据。

一般是2 - 4个节点。

控制网络流量。

#### 仅元数据

还有一个网络仅仅会传递元数据。

每个节点向 1/ 8连接的peer传递gossip，这个表示自己最近IHVAE最近看到的信息。

对等方回复IWANT，表明自己想要的信息。

由不是完整消息对等题的所有网络连接组成。

每个节点向1 / 8的连接每一s传递信息。

#### 分数

通过以下7个标准统计分数。



通过计算分数，确定消息传播度。

- 0:低于这个分数的对等方将从网格中杉树，但仍然会传播gossip信息
- gossipThreshold：低于次将不会传递闲话，负值。



- `P₁`：**时间网**的话题。这是对等点进入网格的时间，上限设置为一个较小的值并与较小的正权重混合。这旨在增强已经在网格中的对等端，从而不会由于超额订阅而过早地修剪它们。
- `P₂`：主题的**首次邮件传递**。这是主题中对等体首先传递的消息数，并带有正权重。这旨在奖励首先转发有效消息的同伴。
- `P₃`：主题的**网格消息传递速率**。此参数是主题中网格内预期消息传递速率的阈值。如果交货数量高于阈值，则该值为0。如果数量低于阈值，则该参数的值为亏损的平方。这是为了惩罚未传递预期数量的消息的网格中的对等点，以便可以将它们从网格中删除。参数与负权重混合。
- `P₃b`：主题的**网格消息传递失败**。这是一个粘性参数，用于计算网格消息传递失败的次数。每当对等点被修剪为负分数时，该参数会因修剪时的速率不足而增加。这是为了保留修剪的历史记录，以使由于交付不足而被修剪的同伴不能迅速地重新植入网格中。参数与负权重混合。
- `P₄`：主题的**无效消息**。这是主题中传递的无效消息的数量。这旨在根据应用程序特定的验证规则对发送无效消息的对等节点进行惩罚。它与负重量混合在一起。
- `P₅`：**应用程序特定**分数。这是应用程序自身使用特定于应用程序的规则分配给对等方的分数组件。权重为正，但是参数本身具有任意实数值，因此应用程序可以在完成特定于应用程序的握手之前用负的分数来发信号表示不当行为或对等。
- `P₆`：**IP共置因子**。该参数是使用相同IP地址的对等体数量的阈值。如果同一IP中的对等方数目超过阈值，则该值为剩余的平方，否则为0。这旨在通过使用少量IP使其难以进行sybil攻击。参数与负权重混合。
- `P₇`：**行为处罚**。此参数捕获对不当行为施加的惩罚。该参数具有关联的（递减）计数器，路由器在特定事件下会明确地增加该计数器。参数的值是计数器的平方，并与负权重混合。

#### 机会嫁接

如果当前发送完整消息的peer的中位数得分比较低，那么会选择两个高于网格中位数的对等节点，改善表现不良的网络。



- 通过最近已经实际转发过八卦的节点替换掉女巫节点。



#### kademlia

用于做内容发现的。

每个key和对应节点的id通过hash函数计算成160单位的bit。



每个key都会放在鱼id值最接近的节点。

通过异或操作。（所有位相同的最小，并且不相同的位最低的最小）



- 路由表由队列组成，ip地址，udp port，nodeID三个。
- kad根据距离生成160个bucket
- 每个bucket放八个节点
- 最后看到的放在尾部，最早看到的放在头部；优先访问尾部。



- 在线时间长的节点，下一时刻就越可能在线。



#### 查询

如果要查找id值为t的节点，就计算自己到t的距离。

然后根据距离找到对应的bucket。

从桶中取出3个节点发送请求。



然后对应的节点也取出自己距离最近的3个节点。



确保收敛速度为O（logN）

值会缓存在key-value节点（过期时间鱼距离成反比）

防止过热，和过冷

#### 安全节点

为了让节点不能自由选择其id，要生成一个公钥，这个公钥两次hash运算后有c1个前导0，那么一次hash运算的值就是nodeid；

不断生成一个随机数，要让随机数与nodeid求异或操作后再求hash有c2个前导0。

随机数，增加难度。使得女巫做法不可取。因为大量生成id很困难。

#### 不相交路径查找

- 为了避免恶意节点不断转发信息，而不回答。
- 每次查询选择d个不相交的桶并发查询



#### bittorrent

- 通过dht知道哪些节点有快
- 优先完成单一片段，
- 尽量从相同的peer请求一个piece的数据（愿意发送一个就愿意发送更多）
- 优先序赞额稀缺片段
- 最少的片段下载慢，因此第一个片段随机选择



- 如果从一个节点速率很低，那么我的速率也很低
- 完成下载后还提供上传服务一段时间
- 最优阻塞，随机一个节点不管它的之前的速率如何
- 阻塞算法，每10s计算一次速率，只跟4个peer连接



- 信用策略
- 计算节点收到数据和发送数据的比率，通过这个计算发送概率
- 不向不诚实的节点发送数据