## ip
Internet Protocol Address，又譯為网际协议地址

#### dhcp

客户在端口67通过udp发送该报文。

使用广播目的地址255.255.255.255.和本主机ip地址0.0.0.0.

广播到所有与该链路连接到的节点。

- dhcp服务器收到dhcp报文后，使用广播ip地址255.255.255.255回复。

包括向客户推荐的ip，网眼掩码以及地址有效期。

- 客户向选定的dhcp服务器发送dhcp请求报文
- dhcp服务器发送ack报文。



#### 输入url到地

首先当我们把电脑和网络连接时。（获得ip地址）

- 生成dhcp请求报文，从目的端口67和源端口68的udp报文段，放到具有广播目的地址255.255.255.255，源目的地址0.0.0.0的ip数据报中
- 包含dhcp请求报文的ip地址被放置在以太网帧中，具有目的mac地址FF:FF:FF:FF， 我的电脑的mac地址,因此以太网服务器把这个以太网帧广播
- 路由器从它连接到以太网的端口接受到以太网帧，因此dhcp服务器收到后就返回ip地址以及dns服务器的ip地址还有默认网关路由器的ip地址。发送回去
- 然后交换机的子学习特性让它直接能够把对应的以太网帧传给我的电脑
- 我的电脑记录网关的ip地址，dns服务器的ip地址，自己的ip地址

（获得网关路由器的mac地址）

- 生成dns查询报文，放到目的端口号54（dns协议）
- 但是现在它还不知道网关路由器的mac地址，因此运行arp协议
- 生成一个具有广播目的地址fffffffff的mac向交换机询问
- 交换机转发给所有的设备
- 网关路由器收到arp请求后，把自己的mac地址回复。

（tcp连接）

- 然后我们就可以发送dns查询报文，当网关收到查询报文后，就通过转发表转发，而它的转发表通过狱内协议OSPF以及狱间协议bgp填写。
- 一般来讲dns服务器慧直接缓存有对应的ip地址，然后回答。





#### ip和tcp只校验首部

ip是有个live字段，防止没经过一个路由器就减一。



https://zhidao.baidu.com/question/621694585768681252.html

#### qos

传统的报文被无区别对待，待用FIFO处理报文。

#### cbwfq加权公平队列

- EF（低时延队列绝对优先发送）
- AF（保证可控带宽）
- BE（使用剩余带宽）



- Ef在调度出队的时候，若EF队列中有报文，则总是优先发送EF队列中的报文，直到EF队列中没有报文时，或者超过为EF队列配置的最大预留带宽时才调度发送其他队列中的报文。（由于优先队列中的报文一般是语音报文（VoIP），采用的是UDP报文，所以没有必要采用WRED的丢弃策略，采用尾丢弃策略即可。）。
- 安抚、用户可以设定每类报文占用的带宽。在系统调度报文出队的时候，按用户为各类报文设定的带宽将报文出队发送。
- be队列（wfq，按照流的优先级分配带宽）

http://www.h3c.com/cn/d_200711/318767_30003_0.htm#_Toc210099742



传统的丢包策略采用尾部丢弃（Tail-Drop）的方法。当队列的长度达到某一最大值后，所有新到来的报文都将被丢弃。

这种丢弃策略会引发TCP全局同步现象——当队列同时丢弃多个TCP连接的报文时，将造成多个TCP连接同时进入拥塞避免和慢启动状态以降低并调整流量，而后又会在某个时间同时出现流量高峰，如此反复，使网络流量不停震荡。



wred：

当队列的长度小于下限时，不丢弃报文；

l       当队列的长度超过上限时，丢弃所有到来的报文；

l       当队列的长度在上限和下限之间时，开始随机丢弃到来的报文。



-  可以实现基于流的WRED。这是因为，在进行分类的时候，不同的流有自己的队列，对于流量小的流，由于其队列长度总是比较小，所以丢弃的概率将比较小。而流量大的流将会有较大的队列长度，从而丢弃较多的报文，保护了流量较小的流的利益。
- 不同优先级概率不一样，高优先级概率小

#### dhcp

1、当客户端接入网络的时候，即启用了dhcp-client后，客户端会发送一个dhcp discover广播报文来发现局域网内的dhcp服务器。因此，第一阶段为dhcp发现阶段，主要意思即为寻找局域网内的dhcp服务器。

2、在局域网内，某个dhcp服务器接收到第一阶段发送过来的报文后，根据自己的地址池内剩下的ip地址，依然以广播方式分配给客户端一个ip地址，分配的dhcp offer报文中还包含了一些其他的字段，如dns地址，网关，掩码等。如果这一阶段内存在多个dhcp服务器，依然会发送多个dhcp offer报文给该客户端。

3、CLient根据先收到的Offer报文来决定选用哪个服务器提供的DHCP的地址（存在多个回应的话，先来的优先），然后根据这个Offer提供的地址信息，发送Request报文请求。

 （1）、客户端初始化时，发送广播的DHCP Request报文来回应服务器的DHCP offer报文

  （2）、客户端重启初始后，发送广播的DHCP的DCHP Request报文来确认先前被分配的IP地址等配置信息。

  （3）、当客户端已知和某个IP地址绑定后，发送单播的DHCP Request报文来延长IP地址租期

4、服务器收到request报文以后，确认地址池中的这个地址没有被分配，如果没有被分配就回复ACK报文，如果被分配了 ，就会回复DHCP-NAK报文，告诉CLient 地址已经被分配了。



作者：西南跑虫
链接：https://www.jianshu.com/p/a6ae9a9c4a37
来源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

#### nat

- 一个公网ipv4对应多个子网ipv4，节省地址
- 10，172，192内部地址

- nat通过不同的端口号识别，把ip，端口号识别位ip，端口号

  #### ip

- ![截屏2020-07-09 下午10.22.11](/Users/jieyang/Library/Application Support/typora-user-images/截屏2020-07-09 下午10.22.11.png)

例如一个IP地址为：192.168.1.255   子网掩码为255.255.255.0。我们将255换算为二进制数，每一个255代表8个1。表示这个地址的网络位是24位，可以简写为192.168.1.255/24

IP地址分类（取值范围：0-255，就是每一个段最小0，最大为255）

自然掩码（主类区分）

A类：1-126.X.X.X/8      取值来源第一段第1位固定：00000000-01111111

B类：128-191X.X.X/16 取值来源第一段前2位固定：10000000-10111111

C类：192-223X.X.X/24 取值来源第一段前3位固定：11000000-11011111




Abc三类地址大小跨度太大

a .b.c.d(x)；x表示前缀，所有前缀相同的代表同一子王。

#### ospf

链路网管协议。

每台路由器在本地运行最短路径算法，也许实现最少跳路由选择。

ospf当链路状态变化时广播链路路由信息。



对于所有的ip，只记录下一跳的路径以及开销。



#### bgp

bgp包括

AS-PATH（经过的as）；next-hop（连接这个as的ip地址）；子网前缀x



as（自叶系统）

一个子网在某个as3系统内。

会使用as3 x 表示这个子网的可达（ibgp）

as间通过ebgp信息表达可达.(ibgp)

最终不同的as都知道了如何到达某个前缀为x的子网。



以及next-hpo连接这个as的ip地址。



- 选择具有最短aspath的路径
- 如果相同，选择最靠近next-hop的路由
- 由ospf和下一跳算法查到路径。

#### icmp

运行在ip之上，有以下几个字段。

实现ping。



icmp类型8（0）：回显请求报文

icmp类型0（0）：回显响应报文

https://zhuanlan.zhihu.com/p/36811342



icmp（3）（11）：发现ttl过期，返回自己的名字和ip地址（traceroute）

icmp（3）（3）：端口不可达（发送一个不存在端口）

#### ipv6

ipv4只有2^32，ipv6有2^128。

ipv4只能支持40多亿。

防止地址不够用



nat穿透可以让多个内网ip公用一个公网ip

https://my.oschina.net/u/4231722/blog/3238347